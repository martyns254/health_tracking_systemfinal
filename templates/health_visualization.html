<!DOCTYPE html>
<html>
<head>
    <title>Health Visualizations - Health Tracking System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #3498db;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        nav ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        nav ul li {
            margin-left: 20px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            transition: transform 0.3s;
            min-height: 300px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        .filter-bar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-label {
            font-weight: 500;
            font-size: 14px;
            color: #7f8c8d;
        }
        select, input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .chart-placeholder {
            width: 100%;
            height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #95a5a6;
            border: 1px dashed #ddd;
            border-radius: 4px;
        }
        .loading-indicator {
            display: none;
            justify-content: center;
            margin: 20px 0;
        }
        .loading-indicator span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #3498db;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 5px;
        }
        .loading-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .loading-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .no-data-message {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            nav ul {
                margin-top: 15px;
                justify-content: center;
            }
            nav ul li {
                margin: 0 10px;
            }
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-group {
                justify-content: space-between;
            }
        }
        .export-btn {
            margin-left: auto;
        }
        .trend-analysis {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .trend-increasing {
            color: #27ae60;
        }
        .trend-decreasing {
            color: #e74c3c;
        }
        .trend-stable {
            color: #3498db;
        }
        .health-insights {
            margin-top: 10px;
            font-size: 14px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Health Visualizations</h1>
            <nav>
                <ul>
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/health/log">Log Health</a></li>
                    <li><a href="/symptoms">Symptoms</a></li>
                    <li><a href="/health/metrics/track">Track Metrics</a></li>
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="filter-bar">
            <div class="filter-group">
                <span class="filter-label">Date Range:</span>
                <select id="date-range">
                    <option value="7d">Last 7 Days</option>
                    <option value="30d" selected>Last 30 Days</option>
                    <option value="90d">Last 3 Months</option>
                    <option value="1y">Last Year</option>
                </select>
            </div>
            <!-- In the filter bar section -->
        <div class="filter-group">
            <span class="filter-label">Export Format:</span>
            <select id="export-format">
                <option value="csv" selected>CSV</option>
                <option value="json">JSON</option>
                <option value="excel">Excel</option>
            </select>
        </div>
            <button id="apply-filters">Apply Filters</button>
            <button id="export-data" class="export-btn">Export Data</button>
        </div>

        <div class="loading-indicator" id="loading">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div id="no-data" class="no-data-message" style="display: none;">
            <p>No health metrics found for the selected period. Try expanding your date range or add new health metrics.</p>
            <a href="/health/metrics/track"><button>Track New Metrics</button></a>
        </div>

        <div class="dashboard-grid" id="metrics-container">
            <!-- Charts will be dynamically inserted here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the logged in user ID from localStorage or session
            const userId = localStorage.getItem('userId');
            if (!userId) {
                window.location.href = '/login';
                return;
            }

            loadUserMetrics('30d'); // Default to 30 days

            // Set up event listeners
            document.getElementById('apply-filters').addEventListener('click', function() {
                const dateRange = document.getElementById('date-range').value;
                loadUserMetrics(dateRange);
            });

            document.getElementById('export-data').addEventListener('click', exportData);
        });

        function loadUserMetrics(dateRange) {
            const userId = localStorage.getItem('userId');
            const container = document.getElementById('metrics-container');
            const loading = document.getElementById('loading');
            const noDataMsg = document.getElementById('no-data');
            
            // Show loading indicator
            loading.style.display = 'flex';
            container.innerHTML = '';
            noDataMsg.style.display = 'none';
            
            // Fetch user's metrics
            fetch(`/user/metrics/${userId}?timeRange=${dateRange}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.length === 0) {
                        noDataMsg.style.display = 'block';
                        return;
                    }
                    
                    // Group metrics by type for visualization
                    const groupedMetrics = groupMetricsByType(data);
                    
                    // Create a chart for each metric type
                    for (const [metricType, metrics] of Object.entries(groupedMetrics)) {
                        createMetricChart(container, metricType, metrics);
                    }
                    
                    // Add symptoms timeline if available
                    fetchSymptomsData(userId, dateRange);
                })
                .catch(error => {
                    console.error('Error fetching metrics:', error);
                    loading.style.display = 'none';
                    container.innerHTML = `
                        <div class="full-width">
                            <p class="no-data-message">Failed to load health metrics. Please try again later.</p>
                        </div>
                    `;
                });
        }

        function groupMetricsByType(metrics) {
            const grouped = {};
            
            metrics.forEach(metric => {
                const name = metric.name || metric.display_name;
                if (!grouped[name]) {
                    grouped[name] = [];
                }
                grouped[name].push(metric);
            });
            
            return grouped;
        }
        function createMetricChart(container, metricType, metrics) {
    // Create chart container
    const chartDiv = document.createElement('div');
    chartDiv.className = 'chart-container';
    
    // Format metric name for display
    const displayName = metrics[0].display_name || formatMetricName(metricType);
    const unit = metrics[0].unit || '';
    
    // Add header with title and add trend analysis div
    chartDiv.innerHTML = `
        <div class="chart-header">
            <h3 class="chart-title">${displayName}</h3>
        </div>
        <canvas id="chart-${metricType.replace(/\s+/g, '-').toLowerCase()}"></canvas>
        <div id="trend-${metricType.replace(/\s+/g, '-').toLowerCase()}" class="trend-analysis"></div>
    `;
    
    container.appendChild(chartDiv);
    
    // Process data and create chart
    const chartData = processMetricDataForChart(metrics);
    createChartJsInstance(
        `chart-${metricType.replace(/\s+/g, '-').toLowerCase()}`, 
        displayName, 
        chartData.labels, 
        chartData.values, 
        unit,
        metricType
    );
    
    // Add trend analysis
    addTrendAnalysis(
        `trend-${metricType.replace(/\s+/g, '-').toLowerCase()}`,
        metricType,
        chartData.values
    );
}

        function processMetricDataForChart(metrics) {
            // Sort by date
            metrics.sort((a, b) => new Date(a.recorded_at) - new Date(b.recorded_at));
            
            const labels = metrics.map(m => formatDate(m.recorded_at));
            const values = metrics.map(m => parseFloat(m.value));
            
            return { labels, values };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function formatMetricName(name) {
            return name
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function createChartJsInstance(canvasId, title, labels, data, unit, metricType) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Choose appropriate colors based on metric type
    const colorPalette = {
        'blood_pressure': { border: 'rgba(231, 76, 60, 1)', background: 'rgba(231, 76, 60, 0.1)' },
        'heart_rate': { border: 'rgba(52, 152, 219, 1)', background: 'rgba(52, 152, 219, 0.1)' },
        'weight': { border: 'rgba(46, 204, 113, 1)', background: 'rgba(46, 204, 113, 0.1)' },
        'temperature': { border: 'rgba(241, 196, 15, 1)', background: 'rgba(241, 196, 15, 0.1)' },
        'default': { border: 'rgba(155, 89, 182, 1)', background: 'rgba(155, 89, 182, 0.1)' }
    };
    
    // Map metric type to color palette
    let metricKey = metricType.toLowerCase().replace(/\s+/g, '_');
    if (!colorPalette[metricKey]) {
        metricKey = 'default';
    }
    
    const colors = colorPalette[metricKey];
    
    // Create enhanced chart
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: title + (unit ? ` (${unit})` : ''),
                data: data,
                backgroundColor: colors.background,
                borderColor: colors.border,
                borderWidth: 2,
                pointBackgroundColor: colors.border,
                pointRadius: 4,
                tension: 0.3,
                fill: true // Fill area under the line
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value + (unit ? ` ${unit}` : '');
                        }
                    },
                    grid: {
                        color: 'rgba(200, 200, 200, 0.2)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(200, 200, 200, 0.2)'
                    }
                }
            }
        }
    });
}

        function fetchSymptomsData(userId, dateRange) {
            fetch(`/symptoms/logs/${userId}?timeRange=${dateRange}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch symptoms data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        createSymptomsTimeline(data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching symptoms data:', error);
                });
        }

        function createSymptomsTimeline(symptoms) {
            const container = document.getElementById('metrics-container');
            
            // Create full-width container for symptoms timeline
            const timelineDiv = document.createElement('div');
            timelineDiv.className = 'chart-container full-width';
            
            timelineDiv.innerHTML = `
                <div class="chart-header">
                    <h3 class="chart-title">Symptoms Timeline</h3>
                </div>
                <canvas id="symptoms-timeline"></canvas>
            `;
            
            container.appendChild(timelineDiv);
            
            // Process symptoms data
            const symptomsByType = {};
            
            symptoms.forEach(symptom => {
                if (!symptomsByType[symptom.symptom_name]) {
                    symptomsByType[symptom.symptom_name] = [];
                }
                symptomsByType[symptom.symptom_name].push({
                    date: new Date(symptom.recorded_at),
                    severity: symptom.severity
                });
            });
            
            // Create datasets for chart
            const datasets = [];
            const colors = [
                'rgba(231, 76, 60, 1)',  // Red
                'rgba(241, 196, 15, 1)', // Yellow
                'rgba(46, 204, 113, 1)', // Green
                'rgba(52, 152, 219, 1)', // Blue
                'rgba(155, 89, 182, 1)'  // Purple
            ];
            
            Object.entries(symptomsByType).forEach(([symptom, occurrences], index) => {
                // Sort by date
                occurrences.sort((a, b) => a.date - b.date);
                
                datasets.push({
                    label: symptom,
                    data: occurrences.map(o => ({
                        x: o.date,
                        y: getSeverityValue(o.severity),
                        severity: o.severity
                    })),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length],
                    tension: 0.1
                });
            });
            
            // Create chart
            const ctx = document.getElementById('symptoms-timeline').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 3,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    const labels = ['None', 'Mild', 'Moderate', 'Severe'];
                                    return labels[value] || '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Severity'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataPoint = context.raw;
                                    return `${context.dataset.label} - ${dataPoint.severity} severity`;
                                }
                            }
                        }
                    }
                }
            });
            addSymptomSummary(container, symptoms);
        }
        function addSymptomSummary(container, symptoms) {
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'chart-container full-width';
    
    // Count symptoms by severity
    const severityCounts = {
        'mild': symptoms.filter(s => s.severity === 'mild').length,
        'moderate': symptoms.filter(s => s.severity === 'moderate').length,
        'severe': symptoms.filter(s => s.severity === 'severe').length
    };
    
    // Count unique symptoms
    const uniqueSymptoms = [...new Set(symptoms.map(s => s.symptom_name))];
    
    // Create symptom frequency data
    const symptomFrequency = {};
    symptoms.forEach(s => {
        if (!symptomFrequency[s.symptom_name]) {
            symptomFrequency[s.symptom_name] = 0;
        }
        symptomFrequency[s.symptom_name]++;
    });
    
    // Sort symptoms by frequency
    const sortedSymptoms = Object.entries(symptomFrequency)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // Top 5 most frequent
    
    // Create the summary content
    summaryDiv.innerHTML = `
        <div class="chart-header">
            <h3 class="chart-title">Symptom Analysis</h3>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px;">
            <div style="flex: 1; min-width: 250px;">
                <h4 style="margin-top: 0; color: #34495e;">Severity Distribution</h4>
                <canvas id="severity-chart" height="180"></canvas>
            </div>
            <div style="flex: 1; min-width: 250px;">
                <h4 style="margin-top: 0; color: #34495e;">Most Frequent Symptoms</h4>
                <canvas id="frequency-chart" height="180"></canvas>
            </div>
        </div>
        <div class="health-insights" style="margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 4px;">
            <p><strong>Key Observations:</strong></p>
            <ul style="margin-top: 5px;">
                ${severityCounts.severe > 0 ? 
                    `<li>You reported <strong>${severityCounts.severe}</strong> severe symptoms. Consider discussing these with your healthcare provider.</li>` : ''}
                <li>Your most frequent symptom was "${sortedSymptoms[0]?.[0] || 'None'}" (${sortedSymptoms[0]?.[1] || 0} occurrences).</li>
                <li>You tracked ${uniqueSymptoms.length} different types of symptoms in this period.</li>
            </ul>
        </div>
    `;
    
    container.appendChild(summaryDiv);
    
    // Create severity distribution chart
    const severityCtx = document.getElementById('severity-chart').getContext('2d');
    new Chart(severityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Mild', 'Moderate', 'Severe'],
            datasets: [{
                data: [severityCounts.mild, severityCounts.moderate, severityCounts.severe],
                backgroundColor: [
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(241, 196, 15, 0.7)',
                    'rgba(231, 76, 60, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Create frequency chart
    if (sortedSymptoms.length > 0) {
        const frequencyCtx = document.getElementById('frequency-chart').getContext('2d');
        new Chart(frequencyCtx, {
            type: 'bar',
            data: {
                labels: sortedSymptoms.map(s => s[0]),
                datasets: [{
                    label: 'Occurrences',
                    data: sortedSymptoms.map(s => s[1]),
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}
        function getHealthInsight(metricType, trend, values) {
    const metricLower = metricType.toLowerCase();
    
    if (metricLower.includes('blood_pressure') || metricLower.includes('bp')) {
        if (trend === 'increasing') {
            return 'Consider reducing sodium intake and monitoring stress levels.';
        } else if (trend === 'decreasing' && Math.min(...values) < 90) {
            return 'Watch for symptoms like dizziness if pressure is getting low.';
        }
    } 
    else if (metricLower.includes('heart_rate')) {
        if (trend === 'increasing' && Math.max(...values) > 85) {
            return 'Consider stress reduction techniques and regular exercise.';
        } else if (trend === 'decreasing' && Math.min(...values) < 60) {
            return 'If experiencing fatigue, consult with a doctor.';
        }
    }
    
    // Default insight
    return `Continue monitoring your ${formatMetricName(metricType)} measurements.`;
}
        function getSeverityValue(severity) {
            switch(severity.toLowerCase()) {
                case 'mild': return 1;
                case 'moderate': return 2;
                case 'severe': return 3;
                default: return 0;
            }
        }

        function exportData() {
            const userId = localStorage.getItem('userId');
            const dateRange = document.getElementById('date-range').value;
            const format = document.getElementById('export-format').value;
            // Download all user metrics as CSV
            window.location.href = `/export/user-data/${userId}?format=${format}&timeRange=${dateRange}`;
        }
        function addTrendAnalysis(containerId, metricType, values) {
    const container = document.getElementById(containerId);
    if (!container || values.length < 3) {
        container.style.display = 'none';
        return;
    }
    
    // Calculate trend using linear regression
    const xValues = Array.from({length: values.length}, (_, i) => i);
    const xMean = xValues.reduce((a, b) => a + b, 0) / xValues.length;
    const yMean = values.reduce((a, b) => a + b, 0) / values.length;
    
    const slope = xValues.reduce((sum, x, i) => 
        sum + (x - xMean) * (values[i] - yMean), 0) / 
        xValues.reduce((sum, x) => sum + Math.pow(x - xMean, 2), 0);
    
    // Determine trend direction
    let trend = "stable";
    let trendClass = "trend-stable";
    let trendIcon = "⟷";
    
    if (slope > 0.1) {
        trend = "increasing";
        trendClass = "trend-increasing";
        trendIcon = "↗";
    } else if (slope < -0.1) {
        trend = "decreasing";
        trendClass = "trend-decreasing";
        trendIcon = "↘";
    }
    
    // Check for abnormal values
    const abnormal = detectAbnormalValues(metricType, values);
    let abnormalWarning = '';
    
    if (abnormal) {
        abnormalWarning = `
            <div style="margin-top: 8px; padding: 8px; background-color: #fff5f5; border-left: 3px solid #e74c3c; border-radius: 0 4px 4px 0;">
                <strong style="color: #e74c3c;">Note:</strong> ${abnormal.count} measurement${abnormal.count !== 1 ? 's' : ''} 
                (${abnormal.percentage}%) ${abnormal.count !== 1 ? 'were' : 'was'} outside the typical range 
                of ${abnormal.range.min}-${abnormal.range.max}.
            </div>
        `;
    }
    
    // Add trend info to container
    container.innerHTML = `
        <div class="${trendClass}">
            <span class="trend-icon">${trendIcon}</span>
            <strong>Trend:</strong> ${formatMetricName(metricType)} is ${trend}
        </div>
        <div class="health-insights">
            ${getHealthInsight(metricType, trend, values)}
        </div>
        ${abnormalWarning}
    `;
}
function detectAbnormalValues(metricType, values) {
    // Define normal ranges for common metrics
    const normalRanges = {
        'blood_pressure': { min: 90, max: 140 },
        'systolic_bp': { min: 90, max: 140 },
        'diastolic_bp': { min: 60, max: 90 },
        'heart_rate': { min: 60, max: 100 },
        'temperature': { min: 36.1, max: 37.2 },
        'glucose': { min: 70, max: 140 },
        'oxygen': { min: 95, max: 100 }
    };
    
    const metricKey = metricType.toLowerCase().replace(/\s+/g, '_');
    const range = normalRanges[metricKey];
    
    if (!range) return null; // No defined range for this metric
    
    // Check for values outside normal range
    const abnormalValues = values.filter(v => v < range.min || v > range.max);
    
    if (abnormalValues.length === 0) return null;
    
    return {
        count: abnormalValues.length,
        percentage: Math.round((abnormalValues.length / values.length) * 100),
        range: range
    };
}
    </script>


<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> 
</body>
</html>